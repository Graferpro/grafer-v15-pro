<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grafer SuperApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: '#4f46e5', darkBg: '#0f172a', cardDark: '#1e293b' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); }
        .dark .glass { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.05); }
        .page { display: none; animation: fadeIn 0.3s ease-out; padding-bottom: 100px; }
        .page.active { display: block; }
        .nav-item.active { color: #4f46e5; transform: scale(1.1); }
        .splash { position: fixed; inset: 0; background: #4f46e5; z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; transition: opacity 0.5s; }
        
        /* Hesap Makinesi Tuşları */
        .calc-btn { height: 65px; border-radius: 16px; font-size: 24px; font-weight: bold; transition: active 0.1s; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .calc-btn:active { transform: translateY(4px); box-shadow: none; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-darkBg text-slate-900 dark:text-white transition-colors duration-300">

    <div id="splash" class="splash">
        <div class="text-center">
            <i data-lucide="zap" size="64" class="mx-auto mb-4 animate-bounce"></i>
            <h1 class="text-3xl font-black tracking-widest">GRAFER PRO</h1>
        </div>
    </div>

    <header class="fixed top-0 w-full glass z-40 px-5 py-4 flex justify-between items-center shadow-sm">
        <div>
            <span class="text-[10px] font-bold text-indigo-500 tracking-widest uppercase">SUPER APP V16</span>
            <h1 class="text-xl font-black" id="page-title">Piyasa</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-100 dark:bg-white/10"><i data-lucide="moon" size="20"></i></button>
        </div>
    </header>

    <div class="h-20"></div> <main id="tab-market" class="page active px-4">
        <div class="w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl mb-6 flex items-center justify-center text-white font-bold shadow-lg">
            <span>Reklam Alanı / Premium Üyelik</span>
        </div>

        <div class="glass p-5 rounded-3xl mb-6 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <img src="https://flagcdn.com/w40/us.png" class="w-6 h-6 rounded-full">
                    <span class="font-bold">USD/TRY</span>
                </div>
                <span id="price-main" class="text-2xl font-black text-indigo-600">---</span>
            </div>
            <div class="h-[150px]"><canvas id="marketChart"></canvas></div>
        </div>

        <h3 class="font-bold text-lg mb-3">Popüler Kurlar</h3>
        <div id="currency-grid" class="grid grid-cols-2 gap-3"></div>
    </main>

    <main id="tab-gold" class="page px-4">
        <div class="grid grid-cols-2 gap-3 mb-6" id="metals-grid">
            </div>
        <h3 class="font-bold text-lg mb-3">Dünya Borsaları</h3>
        <div id="stocks-list" class="space-y-3"></div>
    </main>

    <main id="tab-life" class="page px-4 text-center">
        <div class="glass rounded-[2.5rem] p-8 relative overflow-hidden bg-gradient-to-b from-blue-400 to-blue-600 text-white shadow-xl">
            <div class="absolute top-0 right-0 p-6 opacity-20"><i data-lucide="cloud-sun" size="100"></i></div>
            <h2 id="weather-city" class="text-2xl font-bold mb-1">Konum Alınıyor...</h2>
            <p id="weather-desc" class="text-sm opacity-90 mb-6">---</p>
            <div class="text-7xl font-black mb-6" id="weather-temp">--°</div>
            <div class="grid grid-cols-3 gap-2 text-sm bg-white/10 rounded-xl p-3">
                <div><span class="block opacity-60">Nem</span><span class="font-bold" id="w-hum">-%</span></div>
                <div><span class="block opacity-60">Rüzgar</span><span class="font-bold" id="w-wind">-km</span></div>
                <div><span class="block opacity-60">His</span><span class="font-bold" id="w-feel">-°</span></div>
            </div>
        </div>
        
        <div class="mt-6 grid grid-cols-2 gap-4">
            <div class="glass p-4 rounded-2xl flex flex-col items-center gap-2">
                <i data-lucide="droplets" class="text-blue-500"></i>
                <span class="font-bold">Su Takibi</span>
                <span class="text-xs text-slate-400">Yakında</span>
            </div>
            <div class="glass p-4 rounded-2xl flex flex-col items-center gap-2">
                <i data-lucide="activity" class="text-green-500"></i>
                <span class="font-bold">Adım Sayar</span>
                <span class="text-xs text-slate-400">Yakında</span>
            </div>
        </div>
    </main>

    <main id="tab-calc" class="page px-4 h-[80vh] flex flex-col">
        <div class="flex-1 bg-white dark:bg-cardDark rounded-3xl p-6 mb-4 flex flex-col justify-end items-end shadow-inner">
            <div id="calc-history" class="text-sm text-slate-400 mb-2"></div>
            <div id="calc-display" class="text-5xl font-mono font-bold break-all">0</div>
        </div>
        <div class="grid grid-cols-4 gap-3">
            <button onclick="calcOp('C')" class="calc-btn bg-red-100 text-red-500">C</button>
            <button onclick="calcOp('%')" class="calc-btn bg-slate-100 dark:bg-white/10">%</button>
            <button onclick="calcOp('back')" class="calc-btn bg-slate-100 dark:bg-white/10"><i data-lucide="delete"></i></button>
            <button onclick="calcInput('/')" class="calc-btn bg-indigo-100 text-indigo-600">÷</button>
            
            <button onclick="calcInput('7')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">7</button>
            <button onclick="calcInput('8')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">8</button>
            <button onclick="calcInput('9')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">9</button>
            <button onclick="calcInput('*')" class="calc-btn bg-indigo-100 text-indigo-600">×</button>
            
            <button onclick="calcInput('4')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">4</button>
            <button onclick="calcInput('5')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">5</button>
            <button onclick="calcInput('6')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">6</button>
            <button onclick="calcInput('-')" class="calc-btn bg-indigo-100 text-indigo-600">-</button>
            
            <button onclick="calcInput('1')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">1</button>
            <button onclick="calcInput('2')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">2</button>
            <button onclick="calcInput('3')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">3</button>
            <button onclick="calcInput('+')" class="calc-btn bg-indigo-100 text-indigo-600">+</button>
            
            <button onclick="calcInput('0')" class="calc-btn col-span-2 bg-white dark:bg-cardDark shadow-sm">0</button>
            <button onclick="calcInput('.')" class="calc-btn bg-white dark:bg-cardDark shadow-sm">.</button>
            <button onclick="calcResult()" class="calc-btn bg-indigo-600 text-white shadow-indigo-500/50">=</button>
        </div>
    </main>

    <nav class="fixed bottom-0 w-full bg-white/95 dark:bg-cardDark/95 backdrop-blur-xl border-t border-gray-100 dark:border-white/5 pb-6 pt-3 px-6 z-50 flex justify-between items-center shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="nav('market')" id="nav-market" class="nav-item active flex flex-col items-center gap-1 text-slate-400 transition"><i data-lucide="layout-grid"></i><span class="text-[10px] font-bold">Piyasa</span></button>
        <button onclick="nav('gold')" id="nav-gold" class="nav-item flex flex-col items-center gap-1 text-slate-400 transition"><i data-lucide="gem"></i><span class="text-[10px] font-bold">Borsa</span></button>
        <div class="w-1"></div>
        <button onclick="nav('life')" id="nav-life" class="nav-item flex flex-col items-center gap-1 text-slate-400 transition"><i data-lucide="cloud-sun"></i><span class="text-[10px] font-bold">Hava</span></button>
        <button onclick="nav('calc')" id="nav-calc" class="nav-item flex flex-col items-center gap-1 text-slate-400 transition"><i data-lucide="calculator"></i><span class="text-[10px] font-bold">Hesap</span></button>
        
        <div class="absolute left-1/2 -top-6 transform -translate-x-1/2">
            <button onclick="location.reload()" class="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-xl border-4 border-[#f9fafb] dark:border-darkBg active:scale-95 transition">
                <i data-lucide="refresh-cw"></i>
            </button>
        </div>
    </nav>

    <script>
        // --- CONFIG & STATE ---
        const METAL_INFO = { 'xau': {n:'Altın',i:'gem',c:'#eab308'}, 'xag': {n:'Gümüş',i:'shield',c:'#94a3b8'}, 'xpt': {n:'Platin',i:'disc',c:'#2dd4bf'} };
        const STOCKS = [{ s: 'AAPL', n: 'Apple' }, { s: 'TSLA', n: 'Tesla' }, { s: 'NVDA', n: 'Nvidia' }];
        let state = { base: 'TRY', rates: {}, metals: {}, stocks: {} };
        let calcVal = "0";

        // --- INIT ---
        window.onload = async () => {
            lucide.createIcons();
            
            // Splash Screen Timeout
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').style.display = 'none', 500);
            }, 2000);

            if(localStorage.getItem('theme')==='dark') document.documentElement.classList.add('dark');

            // Fetch Data
            await fetchRates();
            renderMarket();
            
            fetchMetals();
            fetchStocks();
            getLocationWeather();
            
            initChart();
        };

        // --- NAVIGATION ---
        function nav(tab) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(b => {
                b.classList.remove('text-indigo-600', 'active');
                b.classList.add('text-slate-400');
            });
            const btn = document.getElementById('nav-' + tab);
            btn.classList.add('text-indigo-600', 'active');
            btn.classList.remove('text-slate-400');

            const titles = { market:'Piyasa & Döviz', gold:'Emtia & Borsa', life:'Hava Durumu', calc:'Hesap Makinesi' };
            document.getElementById('page-title').innerText = titles[tab];
        }

        // --- API CALLS (PROXY) ---
        async function fetchRates() {
            try {
                const res = await fetch('/api/proxy?type=forex');
                const data = await res.json();
                state.rates = data.results;
            } catch(e){}
        }
        async function fetchMetals() {
            for(let m of Object.keys(METAL_INFO)) {
                try {
                    const res = await fetch(`/api/proxy?type=gold&symbol=${m.toUpperCase()}`);
                    const data = await res.json();
                    if(data.price) {
                        state.metals[m] = data.price * (state.rates[state.base]||1);
                        renderGold();
                    }
                } catch(e){}
            }
        }
        async function fetchStocks() {
            const list = document.getElementById('stocks-list');
            list.innerHTML = '';
            for(let s of STOCKS) {
                try {
                    const res = await fetch(`/api/proxy?type=stock&symbol=${s.s}`);
                    const data = await res.json();
                    const price = data.c * (state.rates[state.base]||1);
                    const isUp = data.dp >= 0;
                    list.innerHTML += `
                    <div class="glass p-3 rounded-2xl flex justify-between items-center">
                        <div class="flex items-center gap-3">
                             <div class="font-bold bg-indigo-50 dark:bg-white/10 w-10 h-10 rounded-full flex items-center justify-center text-xs">${s.s}</div>
                             <div><span class="block font-bold">${s.n}</span><span class="text-xs opacity-50">Hisse Senedi</span></div>
                        </div>
                        <div class="text-right">
                             <span class="block font-bold">${price.toFixed(2)} ${state.base}</span>
                             <span class="text-xs font-bold ${isUp?'text-green-500':'text-red-500'}">${data.dp.toFixed(2)}%</span>
                        </div>
                    </div>`;
                } catch(e){}
            }
        }

        // --- WEATHER ---
        function getLocationWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    try {
                        const res = await fetch(`/api/proxy?type=weather&lat=${lat}&lon=${lon}`);
                        const data = await res.json();
                        
                        document.getElementById('weather-city').innerText = data.name;
                        document.getElementById('weather-temp').innerText = Math.round(data.main.temp) + '°';
                        document.getElementById('weather-desc').innerText = data.weather[0].description.toUpperCase();
                        document.getElementById('w-hum').innerText = data.main.humidity + '%';
                        document.getElementById('w-wind').innerText = data.wind.speed + ' km';
                        document.getElementById('w-feel').innerText = Math.round(data.main.feels_like) + '°';
                    } catch(e) { document.getElementById('weather-city').innerText = "Hata"; }
                }, () => { document.getElementById('weather-city').innerText = "Konum İzni Yok"; });
            }
        }

        // --- RENDERERS ---
        function renderMarket() {
            const list = ['USD', 'EUR', 'GBP', 'RUB'];
            const grid = document.getElementById('currency-grid');
            grid.innerHTML = list.map(c => {
                const val = (1/state.rates[c]) * state.rates[state.base]; // Cross rate
                return `
                <div class="glass p-3 rounded-2xl">
                    <div class="flex items-center gap-2 mb-2"><img src="https://flagcdn.com/w40/${c.slice(0,2).toLowerCase()}.png" class="w-5 h-5 rounded-full"><span class="font-bold text-sm">${c}</span></div>
                    <span class="text-xl font-bold">${val.toFixed(2)}</span>
                </div>`;
            }).join('');
            
            // Main Price
            const usd = (1/state.rates['USD']) * state.rates[state.base];
            document.getElementById('price-main').innerText = usd.toFixed(4);
        }
        
        function renderGold() {
            const grid = document.getElementById('metals-grid');
            grid.innerHTML = Object.keys(state.metals).map(m => {
                const info = METAL_INFO[m];
                return `
                <div class="glass p-4 rounded-2xl relative overflow-hidden">
                    <i data-lucide="${info.i}" class="absolute -right-2 -top-2 opacity-10 w-16 h-16 text-[${info.c}]"></i>
                    <span class="text-xs font-bold opacity-50 uppercase">${info.n}</span>
                    <h3 class="text-xl font-black mt-1">${state.metals[m].toLocaleString(undefined,{maximumFractionDigits:0})}</h3>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- CALCULATOR ---
        function calcInput(k) { if(calcVal==="0") calcVal=k; else calcVal+=k; updateCalc(); }
        function calcOp(op) {
            if(op==='C') calcVal="0";
            else if(op==='back') calcVal = calcVal.slice(0,-1) || "0";
            else if(op==='%') calcVal = String(parseFloat(calcVal)/100);
            updateCalc();
        }
        function calcResult() { try { calcVal = String(eval(calcVal)); } catch { calcVal="Hata"; } updateCalc(); }
        function updateCalc() { document.getElementById('calc-display').innerText = calcVal.substring(0,10); }

        // --- UTILS ---
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        function initChart() {
            const ctx = document.getElementById('marketChart').getContext('2d');
            new Chart(ctx, { type: 'line', data: { labels: Array(10).fill(''), datasets: [{ data: Array(10).fill(1).map(()=>Math.random()), borderColor: '#4f46e5', tension: 0.4, pointRadius:0, fill:true, backgroundColor:'#4f46e520' }] }, options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, maintainAspectRatio:false } });
        }
    </script>
</body>
</html>
